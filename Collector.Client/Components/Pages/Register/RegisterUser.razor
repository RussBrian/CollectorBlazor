@page "/RegisterUser"
@using Collector.Client.Dtos.Login
@using Collector.Client.Dtos
@inject NavigationManager Navigation


<div class="main-container">
    <!-- Form Container -->
    <div class="form-container">
        <MudForm @ref="form" Model="@registerUserViewModel" OnValidSubmit="HandleValidSubmit">

            <!-- Progress Bar -->
            <div class="custom-progress-bar">
                <div class="custom-content-bar" style="width: @(step * 25)%"></div>
            </div>

            <!-- Step Header -->
            <div class="step-header">
                <MudText Typo="Typo.h6" Style="color:#7B885B; margin-left:10px">Paso @(step)-4</MudText>
                <MudText Typo="Typo.h6" Style="color:#8B8C89; margin-right: 10px;">Registrar Persona</MudText>
            </div>

            <div> 
                    <button class="back-to-login-btn" @onclick="NavigateToLogin">
                        <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 0 36 32" width="36">
                            <path d="M0 0h24v24H0z" fill="none" />
                            <path d="M21 11H6.83l3.58-3.59L9 6l-6 6 6 6 1.41-1.41L6.83 13H21z" fill="#BDBBBB" transform="scale(1.4, 1.4)" />
                        </svg>
                        Login
                    </button>

            </div>
            <!-- Form Steps -->
            @if (step == 1)
            {
                <label class="custom-label">Nombre</label>
                <MudTextField @bind-Value="@registerUserViewModel.Name" Required="true" Variant="Variant.Outlined" Style="color:white;" />
                <label class="custom-label mt-5">Apellido</label>
                <MudTextField @bind-Value="@registerUserViewModel.LastName" Required="true" Variant="Variant.Outlined" Style="color:white;" />
                <label class="custom-label mt-5">Nombre de Usuario</label>
                <MudTextField @bind-Value="@registerUserViewModel.UserName" Required="true" Variant="Variant.Outlined" Style="color:white;" />
                <p class="custom-message-required">El campo es requerido.</p>
            }
            @if (step == 2)
            {
                <label class="custom-label">Correo Electrónico</label>
                <MudTextField @bind-Value="@registerUserViewModel.Email" Required="true" Variant="Variant.Outlined" Style="color:white;" />
                <label class="custom-label mt-5">Cédula</label>
                <MudTextField @bind-Value="@registerUserViewModel.Identification" Required="true" Variant="Variant.Outlined" Style="color:white;" />
                <label class="custom-label mt-5">Teléfono</label>
                <MudTextField @bind-Value="@registerUserViewModel.Phone" Required="true" Variant="Variant.Outlined" Style="color:white;" />
                <p class="custom-message-required">El campo es requerido.</p>
            }
            @if (step == 3)
            {
                <label class="custom-label">Contraseña</label>
                <MudTextField @bind-Value="@registerUserViewModel.Password" Required="true" InputType="InputType.Password" Variant="Variant.Outlined" Style="color:white;"/>
                <label class="custom-label mt-5">Confirmar Contraseña</label>
                <MudTextField @bind-Value="@registerUserViewModel.ConfirmPassword" Required="true" InputType="InputType.Password" Variant="Variant.Outlined" Style="color:white;" />
                <p class="custom-message">La contraseña debe contener al menos: 1 letra, 8 caracteres, 1 número y 1 carácter especial ("@@", "!", "#", ".") </p>
            }
            @if (step == 4)
            {
                <div class="custom-image-title">Foto de Perfil</div>
                <MudTextField @bind-Value="@registerUserViewModel.ProfileImage" InputType="InputType.Hidden" />

                <MudFileUpload T="IBrowserFile" @bind-Value="@registerUserViewModel.ProfileImage" AcceptedFileTypes="image/*" MaxFileSize="2097152" />
                @if (registerUserViewModel.ProfileImage != null)
                {
                    <MudText Typo="Typo.body2">Vista previa:</MudText>
                    <img src="@GetImagePreview(registerUserViewModel.ProfileImage)" alt="Imagen de perfil" width="100" height="100" class="image-preview" />
                }
                <p class="custom-message-image">Puedes dar clic en el círculo para seleccionar una imagen o dejar el avatar por defecto.</p>
            }

            <!-- Navigation Buttons -->
            <div class="buttons-container">
                @if (step < 4)
                {
                    <MudButton OnClick="NextStep" Variant="Variant.Filled" Style="color:white; background-color:#7B885B; width:250px;">Siguiente</MudButton>
                }
                else
                {
                    <MudButton Type="Submit" Variant="Variant.Filled" Style="color:white; background-color:#7B885B; width:250px;">Registrar</MudButton>
                }
                <button @onclick="PreviousStep" Variant="Variant.Filled" class="previous-step-btn previous-step-btn-apparience">Paso Anterior</button>
            </div>

        </MudForm>
    </div>
    <!-- Aside Background -->
    <div class="aside-background"></div>

</div>


@code {
    private int step = 1;
    private MudForm form;
    private ReqUserDto registerUserViewModel = new();

    private void NextStep()
    {
        if (step < 4)
            step++;
    }

    private void PreviousStep()
    {
        if (step > 1)
            step--;
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/");
    }

    private void HandleValidSubmit()
    {
        Console.WriteLine("Formulario enviado exitosamente.");
    }

    private string GetImagePreview(IBrowserFile file)
    {
        var buffer = new byte[file.Size];
        file.OpenReadStream().ReadAsync(buffer);
        return $"data:image/jpeg;base64,{Convert.ToBase64String(buffer)}";
    }
}


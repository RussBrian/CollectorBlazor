@page "/User/Create/Reports"
@using Blazored.FluentValidation
@using Collector.Client.Components.Shared;
@using Collector.Client.Dtos.Login
@using Collector.Client.Dtos.Reports;
@using Collector.Client.Services.Reports;
@inject IReportsService _reportService;

<div class="primary-container">
    <main class="secondary-container">
        <EditForm Model="@Report" OnValidSubmit="OnSubmitReport" class="edit-form-style">

            <h3 class="title">Crea un reporte</h3>
            <div class="card-body-container">
                <!-- Aquí inicia el EditForm -->
                <FluentValidationValidator />

                <div class="text-field-container align-content-center">

                    <div class="text-field-style">
                        <div class="d-flex justify-content-between">
                            <label class="custom-label">Título del reporte</label>
                            <ToolTipCustom ToolTipTextStyle="font-weight:bold; font-size:small"
                                           ToolTipDescription="Ayudame"
                                           ToolTipStyle="color:#37490B" />
                        </div>
                        <MudTextField @bind-Value="Report.Title" Variant="Variant.Outlined" Style="custom-textfield" />
                        <p class="text-secondary">Coloque un título que identifique su reporte.</p>
                        <ValidationMessage style="validation-message: 0 ;" For="(() => Report.Title)" />
                    </div>

                    <div class="text-field-style" style="width: 30%;">
                        <label class="custom-label">Fecha</label>
                        <MudTextField ReadOnly="true" InputType="InputType.Date" @bind-Value="TValue"
                                      Variant="Variant.Outlined" Style="custom-textfield" />

                    </div>
                </div>

                <div class="description-container">
                    <label class="custom-label">Descripción</label>
                    <MudTextField @bind-Value="Report.Description" Variant="Variant.Outlined" Style="custom-textfield" />
                    <p class="text-secondary">Coloque una descripción que permita detallar el problema y/o puede indicar otros detalles.</p>
                    <ValidationMessage style="validation-message: 0 ;" For="(() => Report.Description)" />
                </div>

                <div class="map-container">

                    <div>
                        <label class="custom-label">Imágenes</label>
                        <img class="rounded-3" src="@(Report.Files.Any() ? Report.Files.FirstOrDefault() : "./BosqueLindo.png")" width="275px" height="250px" />

                        <MudFileUpload T="IBrowserFile" FilesChanged="UploadFiles" AppendMultipleFiles="true" MaximumFileCount="4">
                            <ActivatorContent>
                                <MudButtonComponent Text="Añadir imagen"
                                                    Variant="Variant.Outlined"
                                                    Style="background-color:transparent;
                            width: 155px; border: 3px solid #767572; color: white;
                            border-radius: 0.5rem;font-weight: bold; margin-top:15px; margin-left:60px" />
                            </ActivatorContent>
                        </MudFileUpload>
                    </div>
                </div>

                <div class="container-message">
                    <MudIcon Icon="@Icons.Material.Filled.ErrorOutline"
                             Size="Size.Small" Style="background-color:darkgray" />
                    <p class="text-secondary ms-4">Dar click sobre el icono para ver mas detalles del campo a completar.</p>
                </div>
            </div>
            <div class="button-send-container">
                <MudButton Variant="Variant.Filled" ButtonType="ButtonType.Submit"
                           Style="background-color:#515B3B;
                        color:white; width:400px;">
                    Crear reporte
                </MudButton>
            </div>
        </EditForm>
    </main>
</div>

<style>
    .img{
       border-radius:10px;
    }

    .text-secondary{
        margin:7px;
    }

    .validation-message{
        color:red
    }

    .edit-form-style {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin-buttom:5px;
    }
</style>

@code {
    public string TValue { get; set; } = DateTime.Now.ToString("yyyy-MM-dd");
    public ReqReportDto Report { get; set; } = new ReqReportDto
    {
       Files = new List<string>()
    };
    IList<IBrowserFile> files = [];

    private void HandleLocationSelected((double Latitude, double Longitude) location)
    {
        Report.Latitude = location.Latitude;
        Report.Longitude = location.Longitude;
    }

    private async void UploadFiles(IBrowserFile file)
    {
        var stream = file.OpenReadStream();
        using var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        var base64Image = Convert.ToBase64String(memoryStream.ToArray());

        Report.Files.Add($"data:{file.ContentType};base64,{base64Image}");
        StateHasChanged();
    }

    private void UploadFiles(InputFileChangeEventArgs args)
    {
        files.Add(args.File);
    }

    public async Task OnSubmitReport()
    {
        var response = await _reportService.CreateReport(Report, files);
    }
}
